YUI.add("tag-helper",(function(e,r){e.TagHelper=class{static parse(e=""){var r;return(r=e.replace(/["“](.*?)["”]/g,((e,r)=>r=(r=r.replace(/(,)/g,((e,r)=>"{COMMA}"))).replace(/(\s)/g,((e,r)=>`{WHITESPACE-${r.charCodeAt(0)}}`))))).split(r.includes(",")?/,/:/\s+/).map(((e,r)=>e=(e=(e=e.replace(/\{WHITESPACE-(\d+)\}/g,((e,r)=>String.fromCharCode(r)))).replace(/\{COMMA\}/g,((e,r)=>","))).trim())).filter((e=>e.length>0))}static dedupe(e=[]){var r=new Map(e.reverse().map((e=>[this.clean(e),e])));return Array.from(r.values()).reverse()}static clean(e=""){return e.replace(/[\s!-\/:-@[-`]/g,"").toLowerCase()}}}),"@VERSION@",{requires:[],optionalRequires:[]});YUI.add("sub-photo-tags-tag-view",(function(e,t){var a=require("hermes-core/flog")(t),s=23;e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(t){return this.photoId=t.photoId,this.context=e.clone(t.context,!0),this.nsid=t.nsid,this.pathAlias=t.pathAlias,this.isMobileTags=t.isMobileTags||!1,this.savedTags=[],""===this.get("container").get("innerHTML")&&this.setContainerHTML(""),this},loadState:function(){var t=this;return new e.FlickrPromise({photo:t.appContext.getModel("photo-models",t.photoId),photoTags:t.appContext.getModel("photo-tags-models",this.photoId),tagModel:t.appContext.getModelRegistry("tag-models"),photoAutotags:t.appContext.getModel("photo-autotags-models",t.photoId),autotagModel:t.appContext.getModelRegistry("autotag-models")}).then((function(e){t.set("photo",e.photo),t.set("photoTags",e.photoTags),t.set("tagModel",e.tagModel),t.set("photoAutotags",e.photoAutotags),t.set("autotagModel",e.autotagModel)}))},buildContainer:function(){var e,t=this.get("photo"),a=this.get("photoTags").getValue("tags"),s=t.getValue("isOwner")||t.getValue("canAddMeta"),o=/^[a-zA-Z]\w*:[a-zA-Z]\w*=.+/,i=[],n=[],l=!1,g=!1,r=!1,h=this.get("photoAutotags").getValue("autotags"),d=t.getValue("isOwner"),p=!1,u=!this.isMobileTags,c=this.appContext.getViewer(),m={selections:[],additionalListClass:"tags-list"},v={selections:[]},f={selections:[],additionalListClass:"machine-tags-list"},T={selections:[]};if(a&&0!==(a=a.toJSON()).length)for(l=!0,e=0;e<a.length;e++)o.test(a[e].tagRaw)?(this.isResponsiveMobilePhotoPage()&&(c.nsid===a[e].tagAuthorNSID||d?f.selections.push(a[e]):T.selections.push(a[e])),i.push(a[e])):(this.isResponsiveMobilePhotoPage()&&(c.nsid===a[e].tagAuthorNSID||d?m.selections.push(a[e]):v.selections.push(a[e])),n.push(a[e]));return h&&0!==(h=h.toJSON()).length&&(g=!0,p=d?this.intlMessage({intlName:"photo-page-scrappy.PRIVATE_TAGS_OWNER_HELPER_TEXT"}):this.intlMessage({intlName:"photo-page-scrappy.PRIVATE_TAGS_FRIENDS_FAMILY_HELPER_TEXT"})),l||g||(r=!0),r&&s&&(this.get("container").addClass("empty"),this.fire("subviewViewEvent","tagsTagView:tagsEmpty")),this.templateConfig={tags:n,machineTags:i,autotags:h,viewerIsOwner:d,privateAutotagHelperText:p,canAddMeta:t.getValue("isOwner")||t.getValue("canAddMeta"),viewerNSID:this.appContext.getViewer().nsid,isOwner:t.getValue("isOwner"),autotagsEnabled:!0,showTagInfoBlock:u,linkTagToTagsPage:!0,tagPageURL:"/photos/tags/",isResponsiveMobilePhotoPage:this.isResponsiveMobilePhotoPage(),tagsContainerIsEmpty:r},this.addTagsModalTemplateConfig={removableRegularTags:m,removableMachineTags:f,nonRemovableRegularTags:v,nonRemovableMachineTags:T,viewerNSID:this.appContext.getViewer().nsid,isOwner:t.getValue("isOwner"),autotagsEnabled:!0,tagsContainerIsEmpty:r},this.selectionLists={removableRegularTags:m,removableMachineTags:f,nonRemovableRegularTags:v,nonRemovableMachineTags:T},!s&&r||this.setContainerWithTemplate("sub-photo-tags-tag-section",this.templateConfig),this},activate:function(){var t,a=this.get("photo"),s=this.get("container"),o=a.getValue("owner")||a.getValue("canAddMeta"),i=this.get("photoTags").getValue("tags"),n=/^[a-zA-Z]\w*:[a-zA-Z]\w*=.+/,l=[],g=s.one(".autotags-helper"),r=this;for(i&&(i=i.toJSON()),0===i.length&&this.fire("subviewViewEvent","noTags"),this.fire("subviewViewEvent","tagsLoaded",i),t=0;t<i.length;t++)n.test(i[t].tagRaw)&&l.push(i[t]);return l.length&&s.one(".machine-tags-section")&&s.one(".machine-tags-section").setStyle("display","block"),!this.isMobileTags&&o&&s.one(".show-add-tags")&&(s.one(".show-add-tags").on("click",(e=>{e.preventDefault(),this.isResponsiveMobilePhotoPage()?this.showAddTagsModal():(s.hasClass("empty")&&(s.removeClass("empty"),r.fire("subviewViewEvent","tagsTagView:tagsNotEmpty")),s.one(".add-tag").setStyle("display","block"),s.one(".add-tag").focus())})),this.setupAddTagEvents(),this.setupRollOverTagEvents(),this.setupRemoveTagEvents(),this.registerEventHandler(e.on("flickr:photo-page--new-tags-added",(function(){r.buildContainer(),r.setupRollOverTagEvents(),r.setupRemoveTagEvents()}))),this.registerEventHandler(e.on("flickr:photo-page:focus_tag_entry",(function(e){var t=r.get("container");t&&t.one(".tags-list .add-tag")&&t.one(".tags-list .add-tag").focus()}))),this.attachKeyEvent("down:84",(function(e){e.preventDefault();try{s.hasClass("empty")&&(s.removeClass("empty"),r.fire("subviewViewEvent","tagsTagView:tagsNotEmpty")),s.one(".add-tag").setStyle("display","block"),s.one(".add-tag").focus()}catch(e){}}))),!this.isMobileTags&&g&&this.registerEventHandler(g.on("click",(function(e){r.showAutotagsHelper(e)}),g)),this},setupAddTagEvents:function(e){var t=e||this.get("container"),a=this;this.registerEventHandler(t.one(".add-tag").on("keydown",(function(e){13===e.charCode||13===e.keyCode?(e.preventDefault(),this.blur()):27===e.charCode&&(e.preventDefault(),this.setAttribute("data-prevent-auto-save",!0),this.blur())}))),this.registerEventHandler(t.one(".add-tag").on("blur",(function(){var e=this,s=e.get("value");""!==s&&(e.hasAttribute("data-prevent-auto-save")?e.removeAttribute("data-prevent-auto-save"):(e.set("value",""),0===s.length&&(s='""'),'""'!==s.trim()&&""!==s.trim()?(t.one(".tags-list").all(".end-of-the-line").removeClass("end-of-the-line"),t.one(".tags-list").all(".not-eol").removeClass("not-eol"),t.one(".machine-tags-section")&&"block"===t.one(".machine-tags-section").getStyle("display")&&(t.one(".machine-tags-list").all(".end-of-the-line").removeClass("end-of-the-line"),t.one(".machine-tags-list").all(".not-eol").removeClass("not-eol")),a.saveTag(s,t),setTimeout((function(){e.focus()}),4)):this.set("text","")))})))},_whichTagList:function(e){var t=/^[a-zA-Z]\w*:[a-zA-Z]\w*=.+/,a=e||this.get("container"),s=[a.one(".machine-tags-list"),a.one(".tags-list")];return function(e){return t.test(e)?s[0]:s[1]}},saveTag:function(t,a,s=!1,o){var i,n,l,g,r=a||this.get("container"),h=this.get("tagModel"),d=this.get("photoTags").getValue("tags"),p=this.get("photoAutotags").getValue("autotags"),u=this._whichTagList(r),c=this;g=e.TagHelper.parse(t),l=g.map((function(e){return e.toLowerCase()})),i=d.getList().some((function(e){return-1!==l.indexOf(e.getValue("tagValue").toLowerCase())})),n=p.getList().some((function(e){return-1!==l.indexOf(e.getValue("autotagValue").toLowerCase())})),h.remoteCreate({photoId:[c.photoId],tags:[t]}).then((function(t){t.forEach((function(e){var t,a=e.getValue("tagRaw"),s=e.getValue("duplicateAutotagId"),o=u(a),i=o.one("[data-tag-id='"+escape(a)+"']");i.setAttribute("data-tag-id",e.getValue("id")),i.setAttribute("data-validated","true"),i.setAttribute("data-tag-might-exist","false"),i.setAttribute("data-author",e.getValue("tagAuthorNSID")),i.addClass("can-remove-tag"),s&&(t=o.one("[data-autotag-content='"+a+"']"),i.setAttribute("data-autotag-id",e.getValue("duplicateAutotagId")),t.remove(!0))})),e.all("[data-tag-might-exist='true']").set("text",c.intlMessage({intlName:"photo-page-scrappy.DUPLICATE_TAG"})).setAttribute("data-validated","true").addClass("invalid-tag"),e.all("[data-validated='false']").set("text",c.intlMessage({intlName:"photo-page-scrappy.INVALID_TAG"})).addClass("invalid-tag"),clearTimeout(c.invalidTagRemoval),c.invalidTagRemoval=setTimeout((function(){r.all(".invalid-tag").remove(!0)}),4500)}),(function(e){var t;t=r.all("[data-validated='false']"),r.all(".autotag").removeClass("hidden"),t.size()&&t.remove(),2===e.code?c.onError(c.intlMessage({intlName:"photo-page-scrappy.MAX_TAG_LIMIT"})):c.onError(c.intlMessage({intlName:"photo-page-scrappy.ERROR_ADDING_TAG"}))})),g.forEach((e=>{var t,a,l,g=u(e).show(),h=g.hasClass("machine-tags-list"),d={tagValue:e.replace(/\s/g,""),tagRaw:e,escapedTagRaw:escape(e),mightExist:i,isDualTag:n,tagWithoutSlashes:e.replace(/\//g,""),linkTagToTagsPage:!0,tagPageURL:"/photos/tags/",isResponsiveMobilePhotoPage:this.isResponsiveMobilePhotoPage(),isNewTag:!0};if(h?(e.indexOf(" ")>0?(a=e.indexOf("=")+1,l=e.substring(0,a)+'"'+e.substring(a)+'"',d.tagValue=l):d.tagValue=e,r.one(".machine-tags-section")&&"none"===r.one(".machine-tags-section").getStyle("display")&&r.one(".machine-tags-section").setStyle("display","block"),t=c.templates("sub-photo-tags-tag")(d)):(d.tagValue=e.replace(/\s/g,""),t=c.templates("sub-photo-tags-tag")(d),n&&g.one("[data-autotag-content='"+e+"']").addClass("hidden")),s)o.removeClass("hidden"),this.savedTags=this.savedTags.filter((t=>t.getAttribute("data-value")!==e));else if(this.isResponsiveMobilePhotoPage()){if(r.one(".tags-list-container").hasClass("empty")&&r.one(".tags-list-container").removeClass("empty"),!i){var p=this.savedTags.find((t=>t.getAttribute("data-value")===e));p?p.removeClass("hidden"):g.prepend(t)}}else g.append(t)})),c.setupRollOverTagEvents()},setupRemoveTagEvents:function(t){var s=t||this.get("container"),o=this.get("photoTags").getValue("tags"),i=this.get("tagModel"),n=this.get("photoAutotags").getValue("autotags"),l=this.get("autotagModel"),g={},r=s.one(".machine-tags-list"),h=this;this.registerEventHandler(s.one(".tags-list-container").delegate("click",(t=>{var d;if((d=h.isResponsiveMobilePhotoPage()?t.target.ancestor("li",!0):t.target).hasClass("remove-tag")||d.hasClass("delete-tag")||d.hasClass("remove-autotag")||d.hasClass("delete-autotag")||d.hasClass("remove-dual-tag")||d.hasClass("delete-dual-tag")){t.preventDefault();var p,u,c=t.target.ancestor(".tag",!0);c?(p=c.getAttribute("data-tag-id"),i.remoteDelete(p).then((function(){o.removeFromList(p,"id"),h.isResponsiveMobilePhotoPage()?(c.addClass("hidden"),h.savedTags.push(c)):c.remove(!0),0===o.toJSON().length&&0===n.toJSON().length?(s.addClass("empty"),h.fire("subviewViewEvent","tagsTagView:tagsEmpty")):0===o.toJSON().length&&s.one(".add-tag").setStyle("display","none")}),(function(){h.onError(h.intlMessage({intlName:"photo-page-scrappy.ERROR_DELETING_TAG"}))})),d.hasClass("remove-dual-tag")||d.hasClass("delete-dual-tag")?(u=c.getAttribute("data-autotag-id"),g.photo_id=h.photoId,g.autotags=u,l.remoteDelete(g).then((function(){n.remove(u,"id")}),(function(){a.warn("deleting the corresponding autotag for this usertag failed")})),e.rapidTracker.beacon(h.name,"dualTagDeleteClick",{type:u})):e.rapidTracker.beacon(h.name,"tagDeleteClick")):(c=t.target.ancestor(".autotag",!0),u=c.getAttribute("data-autotag-id"),g.photo_id=h.photoId,g.autotags=u,l.remoteDelete(g).then((function(){n.remove(u,"id"),c.remove(!0),0===n.toJSON().length&&0===o.toJSON().length&&(s.one(".add-tag").setStyle("display","none"),s.addClass("empty"),h.fire("subviewViewEvent","tagsTagView:tagsEmpty"))}),(function(){h.onError(h.intlMessage({intlName:"photo-page-scrappy.ERROR_DELETING_TAG"}))})),e.rapidTracker.beacon(h.name,"autotagDeleteClick",{type:u})),r.getDOMNode().childElementCount||s.one(".machine-tags-section")&&s.one(".machine-tags-section").setStyle("display","none"),s.one(".tags-list").all(".end-of-the-line").removeClass("end-of-the-line"),s.one(".tags-list").all(".not-eol").removeClass("not-eol"),s.one(".machine-tags-section")&&"block"===s.one(".machine-tags-section").getStyle("display")&&(s.one(".machine-tags-list").all(".end-of-the-line").removeClass("end-of-the-line"),s.one(".machine-tags-list").all(".not-eol").removeClass("not-eol"))}}),"ul.tags-list li:not(.hidden), ul.machine-tags-list li:not(.hidden)"))},setupRollOverTagEvents:function(){var e,t=this.get("container");this.registerEventHandler(t.all(".tags-list, .machine-tags-list").on("mouseover",(function(t){if((e=t.target.ancestor(".tag, .autotag",!0))&&e.hasClass("can-remove-tag")){var a=e.ancestor(".tags-list")?e.ancestor(".tags-list").getDOMNode().offsetLeft:e.ancestor(".machine-tags-list").getDOMNode().offsetLeft,o=e.getDOMNode().offsetLeft;(e.ancestor(".tags-list")?parseInt(e.ancestor(".tags-list").getComputedStyle("width"),10):parseInt(e.ancestor(".machine-tags-list").getComputedStyle("width"),10))-(o-a+parseInt(e.getComputedStyle("width"),10))<=s?(e.removeClass("not-eol"),e.addClass("end-of-the-line")):(e.removeClass("end-of-the-line"),e.addClass("not-eol"))}})))},showAutotagsHelper:function(t){var a=this.get("container").one(".autotags-helper-icon"),s=this.templates("tags-helper-text");new e.Views.FluidDroparound({appContext:this.appContext,dismissOnOverlayClick:!0,showDropArrow:!0,width:240,observePageResize:!0,anchorElement:a,htmlMessage:s({})}).show()},onError:function(t){return this.errorDialog=new e.Views.FluidModal({appContext:this.appContext,dismissOnOverlayClick:!0,dismissOnActionClick:!0,showCancelButton:!1,title:this.intlMessage({intlName:"common.OOPS"}),actionButtonLabel:this.intlMessage({intlName:"common.OK"}),message:t}),this.errorDialog.show(),this.errorDialog},showAddTagsModal:function(){let t,a=this.get("photo"),s=new e.Views["sub-photo-add-tags-view"]({title:"Add tags TMP",showCloseXButton:!0,selectionLists:this.selectionLists,viewerNSID:this.appContext.getViewer().nsid,isOwner:a.getValue("isOwner"),placeholderText:this.intlMessage({intlName:"photo-page-scrappy.SEPARATE_TAGS_WITH_SPACE"}),url:"/photos/me/tags",urlText:"Manage tags TMP",emptyMessage:this.intlMessage({intlName:"photo-page-scrappy.PRESS_ENTER_ADD_TAGS"}),emptyTip:this.intlMessage({intlName:"photo-page-scrappy.TAG_TIP"}),onConfirm:async e=>{t.close(),this.buildContainer(),this.activate()}});t=new e.Views.FluidModal({appContext:this.appContext,subview:s,hasSubviewConfigRefactor:!0}).show()},isResponsiveMobilePhotoPage:function(){return this.appContext.flipper.isFlipped("enable-responsive-mobile-photo-page")&&this.appContext.viewportData.getWidth()<=700}})}),"@VERSION@",{requires:["flickr-view","sub-photo-add-tags-view","hermes-template-sub-photo-tags-tag-section","hermes-template-sub-photo-tags-tag","hermes-template-tags-helper-text","hermes-template-head-meta","url-helper","tag-helper"],optionalRequires:["hermes-core"],optional:[],langBundles:["common","photo-page-scrappy"]});